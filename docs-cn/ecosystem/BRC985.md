# BRC985

## 概述

BRC-985协议定义了一套在区块链上进行代币（Token）和数据可用性（DA）操作的标准。该协议包括代币部署（Deploy）、铸造（Mint）、转移（Transfer）、数据可用性上传（Upload）、周期（Epoch）和数据证明（Prove）等操作。

## 铭文操作

**Creator**：铭文的创建者；
**Create Time**：铭文的创建时间；
**Owner**：铭文的所有者，铭文所在聪的拥有者，当该聪通过UTXO转移到其他地址后，铭文的所有者发生变化；


### Token

#### Deploy

```text
{ 
    "p": "brc-985-token",
    "op": "deploy",
    "tick": "memo",
    "max": "21000000",
    "lim": "1000"
}
```

| key  | Required | Description    |
| ---- | -------- | -------------- |
| p    | yes      | 协议名         |
| op   | yes      | 操作           |
| tick | yes      | 标识符         |
| max  | yes      | 代币最大供应量 |
| lim  | no       | 单次铸币限制   |

1. 按照如下规则检查铭文的值：

- 检查协议名是否为brc-985-token；
- 在代币列表中查看tick代表的代币是否存在；若存在，则该部署铭文无效；
- 若设置铸币限制lim，则铸币限制lim不应大于代币最大供应量max。

2. 若上述检查通过，则部署铭文有效。

3. 更新代币列表，将该代币信息添加到代币列表中。

#### Mint

```txt
{ 
    "p": "brc-985-token",
    "op": "mint",
    "tick": "memo",
    "amt": "1000"
}
```

| key  | Required | Description |
| ---- | -------- | ----------- |
| p    | yes      | 协议名      |
| op   | yes      | 操作        |
| tick | yes      | 标识符      |
| amt  | yes      | 铸币数量    |

1. 按照如下规则检查铭文的值：

- 检查协议名是否为brc-985-token；
- 在代币列表中查看tick代表的代币是否存在；若不存在，则该铸造铭文无效；
- 若在部署时设置了铸币限制lim，则每次铸币值amt必须小于铸币限制lim；
- 检查铸币数量是否已超过代币的最大供应量；即验证已铸造代币量加上本次铸造的代币量是否大于代币的最大供应量。

2. 若上述检查通过，则铸造铭文有效；
3. 更新铸造铭文的Creator地址的可用余额，加上铸币数量amt；
4. 更新已铸造代币量，加上铸币数量amt。

#### Transfer

```txt
{ 
    "p": "brc-985-token",
    "op": "transfer",
    "tick": "memo",
    "amt": "100"
}
```

| key  | Required | Description    |
| ---- | -------- | -------------- |
| p    | yes      | 协议名         |
| op   | yes      | 操作           |
| tick | yes      | 标识符         |
| amt  | yes      | 转移代币的数量 |

<span style="color: red;">注：token的转移分为两步，首先创建转移铭文，随后将转移铭文发送到目标地址，且转移铭文仅第一次转让有效。并将token的余额分为可用余额以及可转让余额。
注：token的转移仅与转移铭文相关，铸造铭文的转移（通过UTXO将铸造铭文发送给其他人）并不会导致余额的变化。</span>

1. 按照如下规则检查铭文的值：

- 检查协议名是否为brc-985-token；
- 在代币列表中查看tick代表的代币是否存在；若不存在，则该转移铭文无效；
- 检查转移铭文的接收地址的可用余额是否大于转移代币的数量amt；若小于，则该转移铭文无效。

2. 若上述检查通过，则转移铭文有效；
3. 更新转移铭文的接收地址的可用余额，减去转移代币的数量amt；
4. 更新目标地址的可转移余额，加上转移代币的数量amt。

### DA

#### Deploy

```txt
{
    "p": "brc-985-da",
    "op": "deploy",
    "tick": "mooda",
    "storage": "",
    "foundation": "",
    "interval": "",
    "token":"",
    "price":""
}
```

| key        | Required | Description                |
| ---------- | -------- | -------------------------- |
| p          | yes      | 协议名                     |
| op         | yes      | 操作                       |
| tick       | yes      | 标识符                     |
| storage    | yes      | 存储地址                   |
| foundation | yes      | 基金会地址                 |
| interval   | yes      | 证明提交周期时间           |
| token      | yes      | 接受的代币                 |
| price      | yes      | 每次上传时所需要支付的费用 |

1. 按照如下规则检查铭文的值：

- 检查协议名是否为brc-985-da；
- 在DA列表中查看tick代表的DA是否存在；若存在，则该部署铭文无效；
- 在代币列表中查看token表示的代币是否存在；若不存在，则该部署铭文无效；

2. 若上述检查通过，则部署铭文有效；
3. 将协议名p以及标识符tick的哈希值，作为DA的默认收款地址。
4. 更新DA列表，将该DA的基本信息添加到DA列表中。

#### Upload

```txt
{
    "p": "brc-985-da",
    "op": "upload",
    "tick": "mooda",
    "id": "",
    "signature": ""
}
```

| key       | Required | Description                 |
| --------- | -------- | --------------------------- |
| p         | yes      | 协议名                      |
| op        | yes      | 操作                        |
| tick      | yes      | 标识符                      |
| id        | yes      | 数据承诺                    |
| signature | yes      | 上传铭文的Creator对id的签名 |

<span style="color: red;">注1：上传操作除了将数据上传至DA外，发起地址还需要支付一定的费用，即上传操作包含隐示的转账，将发起地址的部分token转移到DA的收款地址。</span>

1. 按照如下规则检查铭文的值：

- 检查协议名是否为brc-985-da；
- 在DA列表中查看tick代表的DA是否存在；若不存在同名的DA，则该上传铭文无效；
- 检查上传铭文的Creator地址的余额是否足够；若余额不足以支付上传费用price，则该上传铭文无效；
- 检查数据承诺id的格式；
- 验证签名，签名方式如下：
    ○构建签名原始信息message：按照字典序对id排序，并按照key=value的方式拼接。例如：id=xxx。
    ○对原始信息message进行两次SHA256哈希，得到哈希值h；
    ○使用上传铭文的Creator对应的私钥对哈希值h使用 ECDSA secp256k1 签名，得到签名s，将签名s进行base64编码得到signature。

2. 若上述检查通过，则上传铭文有效；
3. 更新创造上传铭文的地址的余额，减去上传费用price；
4. 更新收款地址的余额，加上上传费用price；
5. 将数据承诺id添加到数据承诺列表中；

<span style="color: red;">注2：当同步器Indexer同步到第一个Upload铭文信息时，将该铭文的创建时间设为起始时间start</span>

#### Epoch

```txt
{
    "p": "brc-985-da",
    "op": "epoch",
    "tick": "mooda"
}
```

<span style="color: red;">注1：Epoch操作是Prove的前置操作，每当进入一个新的挑战周期，必须首先执行Epoch操作，之后才能进行Prove操作。这一步骤是为了防止在证明生成过程中，由于数据上传操作导致证明验证失败。Epoch操作的核心目的是确立挑战周期的状态，明确哪些数据将参与到证明生成的过程中，并且确定在后续Prove操作中的可验证随机数。
注2：Epoch操作会额外检查在之前的周期内，是否存在未提交的情况，若存在，则原本属于存储地址的收益将转给基金会地址。</span>

1. 按照如下规则检查铭文的值：

- 检查协议名是否为brc-985-da；
- 在DA列表中查看tick代表的DA是否存在；若不存在同名的DA，则该Epoch铭文无效；
- 检查铭文的创建时间是否大于起始时间start；若大于则通过；若不大于则继续检查当前状态是否为未提交；若为未提交，则该Epoch铭文无效。

2. 若上述检查通过，则Epoch铭文有效；
3. 按照如下规则计算基金会地址的收益：

- 将铭文的创建时间作为当前时间；
- 计算当前时间与起始时间start的间隔周期数以及间隔周期时间；例如当起始时间为1000，周期为200，当前时间为1523时，则间隔周期数为(1523-1000)/200=2，间隔周期时间为2*200=400；
- 根据间隔周期数以及收款地址的余额，计算罚款；例如间隔2个周期，收款地址的余额为100memo，则罚款总额为100*1%*2=2memo。
- 更新基金会地址foundation的余额，加上罚款值；
- 更新收款地址的余额，减去罚款值；
- 更新起始时间start，加上间隔周期时间，以2中例子为例，会将起始时间更新到1400。

4. 规定所有在数据承诺列表中指定的数据都将参与后续证明生成过程；
5. 规定将当前时间和上一次随机数的哈希值作为最新的可验证随机数；
6. 将DA的状态设为未提交证明。

#### Prove

```txt
{
    "p": "brc-985-da",
    "op": "prove",
    "tick": "mooda",
    "proof": ""
}
```
| key   | Required | Description |
| ----- | -------- | ----------- |
| p     | yes      | 协议名      |
| op    | yes      | 操作        |
| tick  | yes      | 标识符      |
| proof | yes      | 数据证明    |

<span style="color: red;">注1：证明操作除了证明所有数据的可用性之外，存储地址应收取部分费用，该功能包含隐示的转账，将收款地址的部分token转移到存储地址。</span>

1. 按照如下规则检查铭文的值：

- 检查协议名是否为brc-985-da；
- 在DA列表中查看tick代表的DA是否存在；若不存在，则该证明铭文无效；
- 检查当前周期是否已上传证明；若上传过证明，则该证明铭文无效；
- 检查创造证明铭文的地址和存储地址是否一致；若不一致，则证明铭文无效；
- 验证数据证明的正确性；

2. 若检查通过，则证明铭文有效；
3. 更新存储地址storage的余额，加上收款地址余额的1%；
4. 更新收款地址的余额，减去收款地址余额的1%；
5. 更新起始时间start，加上证明提交周期interval；
6. 将DA的状态改为已提交。

### NFT

#### Deploy

```txt
{
    "p": "brc-985-nft",
    "op": "deploy",
    "tick": "mnft",
    "da": "mooda",
    "max": "1000",
    "description": "Bitcoin NFT",
    "id": "",
    "signature": ""
}
```

| key         | Required | Description                         |
| ----------- | -------- | ----------------------------------- |
| p           | 是       | 协议标识符                          |
| op          | 是       | 操作                                |
| tick        | 是       | 唯一标识符                          |
| da          | 是       | 指定存储NFT数据内容的BRC-985-DA系统 |
| max         | 是       | NFT最大发行量                       |
| description | 是       | NFT的描述                           |
| id          | 是       | 描述NFT的图片数据id                 |
| signature   | 是       | 部署铭文的Creator对id的签名         |

<span style="color: red;">注：Deploy操作除了部署NFT集合外，还会将NFT集合的描述图片上传至DA。即Deploy操作包含隐式的上传操作，同样需要支付给DA中storage一定的费用。</span>

1. 按照如下规则检查铭文的值

- 检查协议名是否为brc-985-nft；
- 在NFT列表查看tick代表的NFT是否存在；若存在同名的NFT，则部署铭文无效；
- 在DA列表中查看da代表的DA是否存在；若不存在同名的DA，则部署铭文无效；
- 检查部署铭文的Creator地址的余额是否足够；若余额不足以支付上传费用price，则该铸造铭文无效；
- 验证签名，签名方式如下：
    ○构建签名原始信息message：按照字典序对id排序，并按照key=value的方式拼接。例如：id=xxx。
    ○对原始信息message进行两次SHA256哈希，得到哈希值h；
    ○使用上传铭文的Creator对应的私钥对哈希值h使用 ECDSA secp256k1 签名，得到签名s，将签名s进行base64编码得到signature。

2. 若检查通过，则铭文有效；
3. 更新NFT列表，将NFT的基本信息添加到NFT列表中。

#### Mint

```txt
{
    "p": "brc-985-nft",
    "op": "mint",
    "tick": "mnft",
    "id": "",
    "signature": ""
}
```

| key       | Required | Description                 |
| --------- | -------- | --------------------------- |
| p         | 是       | 协议标识符                  |
| op        | 是       | 操作                        |
| tick      | 是       | 唯一标识符                  |
| id        | 是       | NFT内容的数据承诺值         |
| signature | 是       | 铸造铭文的Creator对id的签名 |

1. 按照如下规则检查铭文的值：

- 检查协议名是否为brc-985-nft；
- 在NFT列表查看tick代表的NFT是否存在；若不存在同名的NFT，则铸造铭文无效；
- 检查id对应的NFT是否已存在；若存在，则铸造铭文无效；
- 检查铸造铭文的Creator地址的余额是否足够；若余额不足以支付上传费用price，则该铸造铭文无效；
- 验证签名，签名方式如下：
    ○构建签名原始信息message：按照字典序对id排序，并按照key=value的方式拼接。例如：id=xxx。
    ○对原始信息message进行两次SHA256哈希，得到哈希值h；
    ○使用上传铭文的Creator对应的私钥对哈希值h使用 ECDSA secp256k1 签名，得到签名s，将签名s进行base64编码得到signature。
- 检查数据承诺id的格式；

2. 若检查通过，则铭文有效；
3. 更新创造上传铭文的地址的余额，减去上传费用price；
4. 更新收款地址的余额，加上上传费用price；
5. 将该NFT添加到NFT列表中；
6. 将该NFT的所有人设置为该铭文的Creator。

#### Transfer

NFT的转移很简单，只需要将Mint铭文发送给指定地址即可。





