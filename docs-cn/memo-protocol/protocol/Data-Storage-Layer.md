# 数据存储层

## 数据存储层的构成

数据存储层由底层存储基础设施以及数据可用层（DA）组成。底层存储技术包括MEFS，IPFS，GreenField，Arweave等，数据可用层包括Meeda和Mooda。

### 关于数据可用层

数据可用层（Data Availability Layer）是用来解决区块链网络中数据存储和可访问性问题的新兴方案，它可以确保所有的网络参与者都能快速且容易的访问到用户数据和其他信息。

数据可用层具有以下特点：

通过将数据存储任务从链上分离出来，有助于减轻链上负担，提高整个网络的处理速度和效率。

可以提供数据验证机制，确保数据的准确性和完整性，同时不会暴露数据本身，提高了存储的隐私性。

可以通过在存储层添加权限控制，保障用户的数据安全以及隐私性需求。

数据存储通常采用分布式存储，有助于保持整个网络的去中心化特性。

兼容性强可以支持多个区块链网络。

+ Meeda

Meeda是由[Memolabs](https://memolabs.org/)推出的基于以太坊安全性的数据可用性解决方案，为以太坊Rollup提供可靠的数据可用性保障。

Meeda的命名来源于MEMO、Ethereum、data availability这些单词，并且与Memolabs推出的比特币数据可用性解决方案Mooda进行联动，前两个字母共同组成MEMO。

Meeda将blob数据放在链下存储，获取数据用的索引和保证数据可用性的承诺证明放在链上存储。在保证了数据可用性的同时，也降低了链上的同步开销和存储开销，最大程度扩展区块链。Meeda兼容任何Optimistic类型的Layer2链，为其提供可靠的数据可用性保障。Meeda依靠链上验证、持续性证明以及冗余机制保障数据的可用性。

+ Mooda

Mooda将数据存储于链下的分散式存储中，将数据的存储凭证和验证信息放在比特币区块链上，验证节点可以随时从链上获取验证信息和存储凭证，来验证存储中的数据是否存在。

Mooda由三个部分组成：存储验证层、比特币区块和索引器。Mooda将用户数据存储于线下的去中心化存储，将存储的证明和验证信息存放于比特币链上，使用索引器获取并验证链上的验证信息。

Mooda通过周期性向区块链提交证明，实现验证的可持续性，为了防止存储证明层使用同一证明，每个周期会选定一个随机数参与证明的生成。

### MEMO底层存储

MEFS为Memolabs自主设计研发的一款分散式存储文件系统，通过各种前沿科技解决了传统存储系统的数据安全性，可靠性，隐私性问题，避免了中心化存储系统的各种弊端，并作为MEMO协议栈的存储基础设施得到应用。

下面重点介绍MEFS存储系统的相关设计理念和设计原理。

#### MEFS设计背景

我们目前所处的信息爆炸时代，每天全球产生成千上万的文档、照片、视频等数据文件。然而，传统的集中式存储方法越来越无法满足市场需求。它成本高昂，其次是安全性不够高，因此区块链分布式存储应运而生。与传统集中式存储相比，区块链分布式存储利用全球各地的闲置电子设备，如闲置的手机、电脑、硬盘等，都可以作为边缘存储节点。区块链去中心化存储的典型特点是去中心化、安全性更高、成本更低，这已经引起了全球资本和技术界的关注。

目前，区块链去中心化存储技术仍处于不断探索的阶段。经过不懈努力，MEMOlab开发出了新一代基于区块链的去中心化云存储系统MEMO。与传统区块链相比，MEMO采用了更简洁高效的技术处理方法来保护守护者、提供者和用户的信息和数据，从而确保整个存储系统的成本效益，并使用户获得更好的使用体验。

#### MEFS的优势

+ 去中心化存储。 用户上传源文件后，Memo系统可以将数据分发到多个存储节点，并对外提供统一标准化的接口。当目标用户发起下载请求时，最近的节点通过最近的节点下载片段并完整地提供给用户。网络中提供多个图像或副本，大大提高了访问速度和稳定性。

+ 全球共享。 多个Memo设备可以形成集群效应，实现全球数据共享、统一存储空间管理和云存储平台的自动负载均衡。文件可以跨区域和网络分布，支持整个网络的数据存储和高效使用，按需扩展以满足用户对高速扩展的需求。

+ 数据安全。 数据存储功能是Memo的基石，数据的安全性和可靠性是数据存储功能的基石。Memo的数据隐私政策要求在写入边缘存储设备之前，源客户端的数据必须使用用户密钥进行加密。此外，访问控制机制确保数据可以由其所有者或其维护者和存储协作访问，而不会被其他用户或无关的维护者和存储者访问。

+ 系统可靠性。 Memo确保可靠性的目标是防止用户设备、维护设备或边缘存储设备失败时数据丢失。可以使用复制、擦除编码等数据冗余技术来确保边缘存储设备上存储的数据的可靠性。

+ 原始数据恢复方法 - RAFI。除了数据冗余机制外，数据修复方法也是决定数据可靠性的重要因素。Memo的原始数据恢复方法RAFI用于进一步提高边缘存储设备中存储数据的可靠性。RAFI技术可以优化边缘存储空间，并更多地保证数据的安全性和系统的稳定性。通过实时查询，可以快速发现高风险的数据丢失，有效地缩短数据修复的总时间并提高性能。

MEMO是一个基于区块链的去中心化云存储系统。它与一些旨在生产区块的项目不同，这些项目的存储数据量直接与区块的计算能力相关；它也不同于伪去中心化的分布式存储项目，这些项目中的一个或几个节点通常承担“中心节点”的功能。

#### 设计意图

由于分布式云存储系统部署在低信任度的P2P网络中，没有中央第三方组织负责管理，存储设备大多是用户的闲置边缘设备，而非专用存储服务器。因此，对于这种应用场景，去中心化云存储管理系统首先面临系统管理问题，这些问题分为系统角色管理、存储市场管理、数据维护管理等，而这些管理需求最终是使用智能合约来实现的。因此，智能合约的管理问题也必须得到解决。

##### 1.系统角色管理：解决角色划分问题

根据存储场景和功能的需求，分布式云存储系统中的用户被划分为三类。这三种类型的用户被定义为用户、提供者和守护者。它们在系统中的功能如下：

+ 用户： 使用存储空间，具体来说：上传数据，由系统中的存储节点存储，是系统中存储服务的消费者。

+ 守护者： 负责信息中介和管理功能，具体来说：收集与其连接的提供者提供的存储信息，如提供者提供1T存储空间；收集与其连接的守护者的评价信息，如其诚信度等；根据用户存储需求找到符合要求的提供者，并挑战提供者。

+ 提供者： 提供存储空间，具体来说：为用户提供存储空间，保存用户数据，是系统中存储服务的提供者。

##### 2.存储市场管理：解决如何实施存储服务的问题

MEMO的关键应用是存储服务，因此存储市场管理是必不可少的。在守护者的帮助下，用户找到合适的提供者。提供者提供存储数据的空间和时间。守护者定期挑战存储数据的提供者。如果发现提供者挑战失败，则需要触发数据修复功能。当用户需要数据时，从提供者那里下载。根据这一应用场景，用户需要向提供者支付存储费和下载数据费，并向守护者支付协调管理费。

如果用户违反存储规则，如损坏数据并拒绝修复等，需要相应的惩罚机制来维护系统的正常运行。守护者如何在用户和提供者之间匹配；建立存储服务后如何根据价格支付；面对用户下载数据的请求时如何解决这些问题。这些问题统称为存储市场管理的需求，MEMO为此设计了存储时长管理解决方案。

##### 3.数据维护管理 - 解决数据维护问题

分布式云存储系统面临数据维护和管理的需求。用户的数据以对象存储的形式存储在选定的提供者上，相应的守护者将挑战以确保守护者完全正确地保存了数据。然而，这种机制缺乏可信度，所有面对同一用户的守护者可能不诚实并提供虚假的挑战结果。

此外，用户的元数据信息存储在相应的守护者上并在守护者之间同步。这可以解决集中式云存储中元数据信息负载不平衡或重复的问题。元数据的正确性以及数据的维护可能会被恶意协商。因此，基于智能合约的去中心化和可信度，与存储数据相关的的重要信息可以存储在智能合约中，以维护数据的正确性。

为了维护数据的安全性和完整性，应用了各种主流的密码技术，如对称加密和解密、抗碰撞哈希函数和数字签名技术，以满足严格的数据隐私和完整性要求。密码技术、数据冗余和修复技术将为系统提供足够的灵活性，以容忍各种可能的软硬件故障和小规模恶意攻击，如试图入侵维护、存储和用户设备，从而篡改、破坏或披露数据和信息。同时，MEMO使用经过验证的POW技术，辅以更创新的POS技术，并辅以第三方安全工具，进一步增强系统安全性。

#### 智能合约

构建大规模去中心化存储系统的关键问题之一是高效管理系统角色及其关系。在分布式云存储系统中，根据不同角色，提供的功能不同，需要保存角色信息以确定用户身份以提供相应功能。传统方法是将用户的角色、地址等信息保存在数据库中，由特定公司管理。在去中心化场景中，根据唯一识别用户的账户地址的特点，使用智能合约来管理系统角色信息。

如上所述，系统对角色管理、存储市场管理、数据维护和管理有需求，这些需求最终需要通过智能合约来实现。因此，智能合约管理是实现上述三种管理需求的基础。合约管理将贯穿整个系统的运行。

##### 如何调用智能合约？

部署智能合约后，用户需要使用合约实例才能调用合约中的方法。合约实例可以通过合约地址构建。对于需要在链上改变状态的某些合约功能，需要特定的用户身份才能调用；而对于获取链上状态信息的合约功能，任何用户都可以调用。因此，系统存在存储和获取合约地址等管理问题。

在MEMO系统中，账户首先注册为某个角色，如用户。在此过程中，账户的地址和用户角色将保存在角色智能合约中。当账户上线时，将调用角色智能合约。您可以获得自己的角色，并根据角色获得相应的服务。账户根据自己的存储需求、条件等决定它想在系统中成为某种角色。用户上线后，从角色模块中获取账户的角色信息。

不同角色有不同的功能，也需要保存角色信息。传统方法是将用户的角色、地址等信息保存在中央数据库中，由特定公司管理。在MEMO系统的去中心化场景中，基于唯一识别用户的账户地址的特点，使用智能合约来管理系统角色信息。在使用的初始阶段，每个用户的守护者由系统随机匹配。在守护者积累了关于提供者的可用性和可靠性的一定数据后，可以建立评分系统来匹配提供者和用户，这可以大大减少交易时间。

需求分析是设计和实施的前提。基于上述管理需求，MEMO设计了多个模块来解决角色划分、存储服务实施数据维护和合约调用的问题。这些都是MEMO系统的坚实基石。

#### 角色

在MEMO分布式云存储系统中，每个用户可以根据自己需要注册一个角色。系统角色包括用户、守护者和提供者。如果是存储需求方，则注册为用户；如果是设备提供方，则注册为提供者；如果只提供信息管理服务，则注册为守护者。本文将从整个系统运行的角度解释每个角色的设计原则。

这三个角色的基本职责如下：

1、用户：是系统中的存储服务消费者，提出存储需求并上传数据。

2、守护者：是系统中的管理协调员，负责信息中介和管理功能。

3、提供者：是系统中的存储设备提供者，为用户提供存储空间。

在这三个角色中，用户和提供者是存储服务的供需双方，用户也是系统中的最终用户。简而言之，用户使用MEMO系统中的存储空间，守护者为用户找到合适的存储节点，

存储节点提供者为用户提供数据存储。守护者相当于中间信息匹配者，为用户提供和提供者提供中介服务。我们可以将守护者理解为招聘平台上的猎头或房地产交易平台上的中介。

##### 用户

由于系统中的最终用户是用户，因此需要为存储服务支付相应的存储费用，因此每个服务请求都由用户发起。

当用户提出存储服务需求时，应包括以下要素：存储空间大小、存储时长；提供者和守护者的数量；以及所需的存储单位价格。

因为只有在设置上述参数后，守护者才能检索和匹配相应的存储节点。同时，在去中心化云存储系统中，存储节点越多，数据越安全，但存储节点越多，支付的费用越高。因此，用户需要自己确定存储节点提供者和中间管理者守护者的数量，并需要在成本和数据安全之间找到平衡。

用户不仅需要支付存储服务费用，当他们需要从提供者下载数据时，也需要支付下载费用，因为下载操作将给提供者带来流量和设备的消耗。

由于用户是最终支付方，系统对这个角色没有设置特别限制，因为如果用户不支付，提供者和守护者将停止服务。但对于其他两个角色，提供者和守护者，系统为他们设置了相应的惩罚措施，将在下文讨论。

##### 守护者

守护者如何工作

守护者是系统中重要的中介角色。它承担信息中介和管理功能，并从用户支付的存储费用中提取管理佣金。

作为信息中介，其基本功能是匹配信息，即匹配需求方和供需方之间的信息。当用户提出存储需求时，守护者将根据用户的要求找到与其连接的提供者，并匹配合适的存储节点。

除了基本的信息匹配外，守护者的管理功能主要体现在参与挑战和触发支付上。守护者定期发起并参与对提供者的挑战。其目的是验证提供者是否完整存储数据，即验证提供者的真伪和诚信。根据挑战结果，我们可以了解每个提供者在这段时间内为用户有效存储了多少和多长时间的数据，这将作为用户后续支付的依据。

此外，守护者另一个重要的功能是触发存储费用的支付。支付不是由支付方用户或支付方提供者触发的，而是由中间人守护者触发的。这主要是为了增加系统的公平性。由中间人守护者触发可以减少欺诈行为的概率。

+ 守护者的惩罚机制

守护者作为中介，参与系统的管理。虽然它在一定程度上可以解决分布式存储系统存储供需的信任问题，但认为守护者本身可能缺乏诚信，例如不及时挑战存储的数据，不及时触发支付。为了触发支付，MEMO因此为角色设计了惩罚措施。惩罚机制的存在可以在一定程度上确保系统的良性运行和社区的健康发展。

因此，系统规定，当账户注册为守护者时，必须质押费用。这个费用可以由账户退还，也可以在账户违反系统规定时扣除。如果账户质押的金额不足，或者没有质押存款金额，那么就没有诚信背书，账户的守护者角色无法建立。关于守护者质押的金额，何时扣除罚款以及扣除多少可以链下确定。

通常，当账户严重违反系统规定时，将对账户进行处罚。如果守护者无法按时进行存储数据的空间-时间挑战，同步空间-时间挑战的结果并报告空间-时间挑战的结果很长时间，那么系统将禁止该账户。一旦账户被禁止，它将永远不会再成为守护者。

当守护者被禁用时，如果守护者质押的余额不为0，则该余额可以如下处理：归还给账户；转移给部署角色合约的角色管理员；转移给违反系统规定的守护者。其他受影响的账户包括用户、守护者和提供者。

##### 提供者

提供者是系统中提供存储空间的一方。它为用户提供存储服务，并从用户那里获得支付的费用。提供者上线后，需要说明自己的存储情况，包括可用的存储空间、存储时长和所需的存储单位价格。提供者说明自己的情况后，守护者可以根据用户和提供者的情况匹配，然后将匹配的提供者信息发送给用户，以便用户、守护者和提供者形成一个存储服务。

像守护者一样，提供者也有触发支付的功能，只不过守护者触发的是存储费用的支付，而提供者触发的是下载费用的支付。这是因为存储费用的验证需要中间管理者守护者的参与，而下载费用的验证不需要中间管理者的参与。

+ 提供者的惩罚机制

上述提到了对守护者的违规行为进行惩罚。对于提供者，系统也设计了奖励和惩罚机制，因为提供者可能会有问题，比如数据损坏但不恢复，长期不响应用户下载数据请求或守护者挑战。这不仅会破坏用户的数据，还会严重影响用户体验。

因此，对于提供者角色，在申请角色时也需要质押费用。一旦提供者违反系统规则，系统将触发相应的惩罚来扣除质押的金额。

#### 惩罚合约部署者：第三方合约管理员Admin

从系统设计的角度来看，每个角色都可以在MEMO系统中获得收益。由于用户是最终消费者，惩罚措施主要是针对收集角色，即守护者和提供者，系统角色功能的实现和角色之间的互动是通过智能合约实现的，因此惩罚也是通过智能合约实现的。

采用基于合约的惩罚机制的原因是：在低信誉环境中部署的去中心化系统，没有具体的组织决策，实施奖惩，而合约具有所有事先制定的条款和执行流程，并且是在计算机的绝对控制下执行的优势。此外，智能合约编译后部署在区块链上，并由虚拟机执行，区块链上的每个节点都会运行智能合约的过程，因此智能合约的执行过程和执行可以实现分布式监督和仲裁的结果。

借助智能合约的这些优势，可以事先在合约中规定提供者和守护者的惩罚机制。对于谁触发智能合约的质押扣除功能的问题，可用的解决方案包括：由用户触发；由守护者触发；由其他提供者触发；或由角色合约部署者触发。系统中的任何角色都不适合触发提供者和守护者的质押扣除功能。原因是他们三个在存储服务中相互关联。提供者通过为用户存储数据获得收入，守护者通过帮助用户挑战验证数据和收集信息获得收入。因此，触发质押扣除功能的权力应该转移到一个无关的第三方，即角色合约部署者，这里称为合约管理员Admin。Admin部署惩罚合约，这也是MEMO系统为了实现公平交易而设计的一种制衡机制。

#### MEMO文件系统的节点匹配

MEMO系统的核心应用是一个去中心化的区块链。为了在低信任度环境中实现公平交易，系统为每个角色设计了相应的功能，存储需求方（用户）、存储协调方（守护者）、存储提供方（提供者）相互交互，形成一个系统生态系统。本文将详细阐述MEMO系统的节点匹配，即用户如何找到为自己提供存储服务的提供者？

##### 用户的需求参数设置

用户是系统的最终消费者。每项存储服务都由用户发起，然后守护者和提供者为其提供服务。在角色设计文章中，我们提到当用户提出存储服务要求时，应包括以下元素：存储空间大小、存储时长和提供者和守护者的数量。

存储空间大小和存储时长是最基本的参数。至于为什么要选择提供者和守护者的数量，是因为MEMO系统使用对象存储，并且离线维护数据使用数据冗余：多个副本或纠错码，因此存储节点越多，数据越安全。因为一旦存储节点上的数据丢失，其他存储节点可以帮助恢复其数据。在这个去中心化云存储系统中，存储节点越多，所有存储节点中数据损坏或丢失的概率越小。但选择的存储节点越多，用户支付的存储服务费用就越高。因此，用户对存储服务的要求也应包括提供者的数量。用户衡量成本和数据安全问题，并确定存储节点提供者的数量。

同样，因为守护者需要及时挑战提供者的空间-时间，即通过数据验证技术，检查提供者正确存储了多少数据和存储时长，多个守护者同意挑战结果，共识结果作为支付提供者存储数据的依据。守护者的数量会影响这项存储服务。原因是：守护者越多，伪造挑战结果的成本越高，所有守护者都离线的概率越低。

##### 用户的其他参数设置：信誉值、价格

当用户提出存储要求时，除了存储空间、存储时长和提供者及守护者数量的基本参数外，根据具体使用场景，可能还会设置一些其他参数。

因为每个提供者的诚信度可能不同，有些提供者可以保证每次都正常存储数据并且可以长时间在线，而有些提供者则不能。因此，根据需要，也可以选择提供者的信誉值，这来自于提供者历史服务的表现。当提供者保证长时间在线并且正常为用户存储数据并积极回应守护者的挑战时，其信誉值会更高。信誉值越高，未来与用户匹配的机会就越大。

同样，对于守护者，除了数量要求外，信誉值也会涉及。用户在设置参数时也可以要求守护者的信誉值，因为每个消费者都希望与信誉高的合作伙伴合作。

此外，系统应为用户提供指定存储服务价格的功能，例如为每1MB数据的每天存储支付多少钱。具体的存储单位价格可以根据系统的实际使用情况确定。

总之，用户在寻求存储服务时需要指定的参数包括存储空间大小、存储时长、存储单位价格、守护者参数要求（如守护者数量）和提供者参数要求（如提供者数量）。

##### 智能合约匹配

用户设置所需参数后，守护者将根据用户的存储服务要求找到与其连接的提供者，并匹配合适的存储节点。匹配操作的具体情况是：提供者上线后，

说明自己的存储情况，应包括：可用存储空间、存储时长和所需的存储单位价格。因此，守护者根据双方的情况匹配，然后将匹配的提供者信息发送给用户。从而，用户、守护者和提供者形成一个存储服务。

对于守护者如何根据用户和提供者的存储条件进行匹配的问题，第一个解决方案是：当节点连接时，用户和提供者主动将自己的存储服务相关信息发送给守护者；第二个解决方案是：使用智能合约在链上记录用户的存储要求和提供者的存储条件。当连接到守护者时，守护者直接在链上查看匹配。与这两种解决方案相比，第一个解决方案将增加系统网络的负担，并且后续存储服务缺乏可审核性。第二个解决方案将信息记录在智能合约中，具有分布式监督和不可篡改的特点，只有守护者从链上查询信息不会造成比第一个解决方案更大的网络负担，并且也方便审计，但用户和提供者需要承担部署智能合约的成本。

因此，与存储服务相关的各种参数信息将通过智能合约记录，包括用户对存储服务的需求参数和提供者可以提供的存储服务相关参数。可以说，智能合约贯穿整个MEMO系统。
